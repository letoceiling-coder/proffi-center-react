# Шаг 5.2 — CMS Media library

Реализована медиатека CMS: cms_media, cms_media_files, загрузка файлов, привязка к сущностям через cms_mediables.

---

## Что сделано

### Backend

- **CmsMediaController** (`App\Http\Controllers\Api\Cms\CmsMediaController`):
  - **index** — список с поиском по name/alt/caption, пагинация, withCount('files').
  - **store** — создание записи cms_media (name, alt, caption) без файла.
  - **show** — одна запись с files.
  - **update** — обновление name, alt, caption.
  - **destroy** — удаление медиа и файлов с диска (Storage::disk->delete), затем удаление записи (каскад по БД удалит cms_media_files).
  - **upload** — POST с полем `file`; валидация по config/media (max_size, allowed_mime_types); сохранение в disk `public`, путь `cms/Y/m/d`; создание CmsMedia + CmsMediaFile (disk, path, variant=original, mime_type, size, width/height для изображений через getimagesize).
  - **attach** — POST cms-media/{id}/attach: mediable_type (Page|Service|Product), mediable_id, role?, order?; привязка через pivot cms_mediables (без удаления медиа при удалении страницы — только detach в модели).
  - **detach** — отвязка по mediable_type, mediable_id, role?.

- Валидация по DB_SCHEMA и config/media.php (лимиты, MIME).

- **Маршруты** (auth:sanctum, prefix cms):
  - POST `cms-media/upload`
  - POST `cms-media/{cms_media}/attach`, POST `cms-media/{cms_media}/detach`
  - apiResource `cms-media` (index, store, show, update, destroy).

### Frontend

- **CmsMedia.vue** (`resources/js/pages/admin/cms/CmsMedia.vue`): список с поиском, пагинация, кнопка «Загрузить файл» (input file → POST /cms/cms-media/upload), редактирование name/alt/caption в модалке, удаление.
- Маршрут: `admin.cms.media`, путь `cms/media`.
- Пункт меню: «Медиатека CMS» (роли admin, manager).

### Поведение

- При удалении Page/Service/Product вызывается только detach() для cmsMedia — записи cms_media не удаляются.
- При удалении cms_media удаляются связанные cms_media_files (каскад в БД) и файлы с диска в контроллере.

---

## Команды проверки

```bash
php artisan route:list --path=cms-media
php artisan test tests/Feature/ModelsRelationsTest.php tests/Feature/CmsMultisiteApiTest.php tests/Feature/AdminApiTest.php
```

Ручная проверка: /admin → Медиатека CMS — загрузка файла, просмотр списка, редактирование, удаление. Ссылка на storage: `php artisan storage:link` если ещё не сделано.
