# Шаг 5.6 — SchemaBlocks (микроразметка JSON-LD) и Reviews + ReviewMedia

Реализованы /admin (Vue) и API (Laravel) для управления блоками микроразметки (schema_blocks) и отзывами с медиа (reviews, review_media). Без новых таблиц/полей; site_id NOT NULL где предусмотрено; медиа отзывов — только cms_media через таблицу review_media.

---

## Часть A — SchemaBlocks

### Backend (api/v1/cms, auth:sanctum)

- **GET** `/api/v1/cms/schema-blocks?site_id=&type=&q=` — список с фильтром по site_id (блоки сайта или сущностей этого сайта), по type и поиском в data.
- **POST** `/api/v1/cms/schema-blocks` — создание. Body: schemaable_type (App\Models\Site | Page | Service), schemaable_id, type, data (JSON), is_enabled, order.
- **GET** `/api/v1/cms/schema-blocks/{id}` — просмотр.
- **PUT** `/api/v1/cms/schema-blocks/{id}` — обновление.
- **DELETE** `/api/v1/cms/schema-blocks/{id}` — удаление.

**Валидация:** type из списка (Organization, LocalBusiness, Service, BreadcrumbList, FAQPage); data — массив с минимальной проверкой обязательных ключей по type (Organization: @type, name; LocalBusiness: @type, name; Service: @type; BreadcrumbList: @type, itemListElement; FAQPage: @type, mainEntity); schemaable_id должен существовать для выбранного schemaable_type. **Ограничение «не более одного включённого блока данного type на сущность»:** при сохранении блока с is_enabled=true остальные блоки с тем же type и тем же (schemaable_type, schemaable_id) отключаются (в транзакции).

### Vue

- **SchemaBlocks.vue** — фильтр по сайту, type и поиск; таблица блоков; создание/редактирование в модалке: привязка к сайту (site-level) или к сущности (страница/услуга) с выбором сайта и конкретной записи; type, data (textarea JSON с подсказкой), is_enabled, order. Меню: пункт «Микроразметка (Schema)».

---

## Часть B — Reviews + ReviewMedia

### Backend (api/v1/cms, auth:sanctum)

- **GET** `/api/v1/cms/reviews?site_id=&status=&q=&page=` — список отзывов.
- **POST** `/api/v1/cms/reviews` — создание. Валидация: site_id, author_name (required), text (required), phone (nullable), published_at (nullable|date), status (draft|published|hidden).
- **GET** `/api/v1/cms/reviews/{id}` — просмотр (с media).
- **PUT** `/api/v1/cms/reviews/{id}` — обновление.
- **DELETE** `/api/v1/cms/reviews/{id}` — удаление (каскад review_media по FK).
- **POST** `/api/v1/cms/reviews/{id}/media` — синхронизация медиа. Body: `media_ids[]` (массив id из cms_media). Порядок = индекс в массиве (order в review_media).
- **DELETE** `/api/v1/cms/reviews/{id}/media/{media_id}` — отвязать одно медиа.

### Vue

- **Reviews.vue** — список по сайту, фильтр по статусу, поиск; создание/редактирование отзыва (автор, текст, телефон, статус, дата публикации); блок «Медиа»: список прикреплённых с кнопками ↑/↓ и удалить, кнопка «Добавить из медиатеки» (CmsMediaPicker). При сохранении после создания/обновления отзыва вызывается sync media (media_ids в порядке списка). Меню: пункт «Отзывы».

---

## Эндпоинты (сводка)

| Метод | URL | Описание |
|-------|-----|----------|
| GET | /api/v1/cms/schema-blocks | Список (site_id, type, q) |
| POST | /api/v1/cms/schema-blocks | Создание блока |
| GET/PUT/DELETE | /api/v1/cms/schema-blocks/{id} | Просмотр, обновление, удаление |
| GET | /api/v1/cms/reviews | Список отзывов (site_id, status, q) |
| POST | /api/v1/cms/reviews | Создание отзыва |
| GET/PUT/DELETE | /api/v1/cms/reviews/{id} | Просмотр, обновление, удаление |
| POST | /api/v1/cms/reviews/{id}/media | Синхронизация медиа (media_ids[]) |
| DELETE | /api/v1/cms/reviews/{id}/media/{media_id} | Отвязать медиа |

---

## Как проверить

1. **Тесты:** `php artisan test` — все тесты (в т.ч. CmsSchemaBlocksApiTest, CmsReviewsApiTest) проходят.
2. **Микроразметка:** /admin → Микроразметка (Schema) → фильтр по сайту/типу → создать блок (привязка к сайту или странице, type Organization, data с @type и name) → проверить, что при включении второго блока того же типа и той же сущности первый отключается.
3. **Отзывы:** /admin → Отзывы → создать отзыв (сайт, автор, текст, статус) → в редактировании прикрепить медиа из медиатеки, изменить порядок ↑/↓ → сохранить и проверить, что медиа сохранились в нужном порядке.

---

## Файлы (новые/изменённые)

**Backend:**  
- app/Http/Controllers/Api/Cms/SchemaBlockController.php  
- app/Http/Controllers/Api/Cms/ReviewController.php  
- app/Models/Site.php (schemaBlocks)  
- app/Models/Review.php (HasFactory)  
- database/factories/ReviewFactory.php  
- routes/api.php (schema-blocks, reviews, reviews/{id}/media)  

**Vue:**  
- resources/js/pages/admin/cms/SchemaBlocks.vue  
- resources/js/pages/admin/cms/Reviews.vue  
- resources/js/admin.js (маршруты)  
- app/Services/AdminMenu.php (Микроразметка, Отзывы)  

**Тесты:**  
- tests/Feature/CmsSchemaBlocksApiTest.php  
- tests/Feature/CmsReviewsApiTest.php  

**Документация:**  
- docs/steps/STEP_05_06.md  
- docs/ADMIN_MODULES.md (разделы Schema, Reviews)  
- docs/SEO_AND_SCHEMA.md (выбор schema_blocks для страницы/сайта)
