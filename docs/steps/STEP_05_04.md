# Шаг 5.4 — SEO CMS: SeoMeta, SeoSettings, Redirects, SeoResolver

Реализовано управление SEO в /admin и в CMS API: SeoMeta (morphOne к Page/Service/ProductCategory/Product), SeoSettings (по site, одна запись на сайт; глобальные = root site is_primary=1), Redirects (site-aware, UNIQUE(site_id, from_path)), единый сервис SeoResolver. Без новых таблиц/полей; site_id NOT NULL везде.

---

## Что сделано

### Backend (Laravel)

**SeoSettings**

- **GET** `/api/v1/cms/seo-settings?site_id=` — возвращает запись для сайта; если нет — создаётся (firstOrCreate), затем возвращается. Обязательный query: `site_id` (exists:sites,id).
- **GET** `/api/v1/cms/seo-settings/{id}` — show по id.
- **PUT** `/api/v1/cms/seo-settings/{id}` — обновление. Валидация: default_title_suffix, default_description (длины), verification_google, verification_yandex, robots_txt_append (nullable, макс. длины по схеме). В БД нет default_og_image_media_id — только в seo_meta.
- Гарантия: одна запись seo_settings на site (unique site_id).

**SeoMeta**

- **GET** `/api/v1/cms/{entity}/{id}/seo-meta` — entity: `pages` | `services` | `product-categories` | `products`. Возвращает `data`: объект seo_meta или null.
- **PUT** `/api/v1/cms/{entity}/{id}/seo-meta` — upsert. Поля: title, description, h1, canonical_url (url), robots, og_title, og_description, og_image_media_id (nullable, exists:cms_media,id), twitter_card, twitter_title. Валидация длин по DB.
- og_image_media_id проверяется через `exists:cms_media,id`.

**Redirects**

- **GET** `/api/v1/cms/redirects?site_id=&q=&sort=&order=&per_page=` — список с фильтром по site_id и поиском по from_path/to_url.
- **POST** `/api/v1/cms/redirects` — создание. Валидация: site_id required, from_path — required, строка, начинается с `/`, unique(site_id, from_path); to_url required; code — 301 или 302; is_active — boolean.
- **GET/PUT/DELETE** `/api/v1/cms/redirects/{id}` — show, update, destroy.
- to_url разрешён как абсолютный URL, так и путь (path only). from_path — только путь с ведущим `/`.

**SeoResolver** (`App\Services\SeoResolver`)

- Метод `resolveFor(entity, site)` возвращает массив: `title`, `description`, `h1`, `canonical`, `robots`, `og_title`, `og_description`, `og_image_url`.
- Приоритет: (1) seo_meta на сущности; (2) поля сущности (title/name, short_description для Product); (3) seo_settings текущего сайта; (4) seo_settings root site (is_primary=1).
- og_image_url: из seo_meta.og_image_media_id → cms_media_files (вариант `og`, иначе `original`, иначе первый файл). В seo_settings в текущей схеме нет default_og_image_media_id.
- canonical: если задан seo_meta.canonical_url — используется; иначе собирается из домена сайта и пути сущности (Page: /{slug}, Service: /uslugi/{slug}, ProductCategory: /catalog/{slug}, Product: /catalog/{category_slug}/{slug}).
- robots: seo_meta.robots или по умолчанию `index,follow`.

**Модели**

- ProductCategory: добавлена связь `seoMeta()` (MorphOne) и удаление seo_meta при удалении категории (booted deleting).

### Frontend (Vue /admin)

- **PageEdit.vue** — вкладка SEO: полноценная форма (title, description, h1, canonical_url, robots, og_title, og_description, OG image через CmsMediaPicker, twitter_card, twitter_title). Кнопка «Сохранить SEO» — PUT pages/{id}/seo-meta (upsert). При загрузке страницы подгружается GET seo-meta и форма заполняется.
- **CmsMediaPicker.vue** — компонент выбора медиа: поле ID + кнопка «Выбрать из медиатеки», модальное окно со списком из GET /cms/cms-media (поиск, выбор по клику). Используется для og_image_media_id.
- **SeoSettings.vue** — страница «SEO Настройки»: выбор сайта (select), загрузка GET seo-settings?site_id=; форма default_title_suffix, default_description, verification_google, verification_yandex, robots_txt_append; сохранение PUT seo-settings/{id}.
- **Redirects.vue** — страница «Редиректы»: список по site_id и поиск q; создание/редактирование в модалке (site_id, from_path, to_url, code 301/302, is_active); подсказки по from_path (начинается с /) и code.
- Маршруты: `cms/seo-settings`, `cms/redirects`. Меню: пункты «SEO Настройки», «Редиректы» (AdminMenu.php).

### Тесты

**tests/Feature/CmsSeoApiTest.php** (15 тестов):

- seo_settings: index требует site_id; index возвращает или создаёт запись для сайта; update (unique per site).
- seo_meta: show возвращает null когда записи нет; upsert для page (создание и обновление); og_image_media_id — 422 при несуществующем id; 200 при существующем cms_media; unknown entity — 404.
- redirects: store — from_path без ведущего `/` — 422; store и уникальность (site_id, from_path); один и тот же from_path для разных сайтов разрешён; update и delete.
- SeoResolver: meta перекрывает settings; fallback на поля сущности и seo_settings сайта; fallback на seo_settings root site.

---

## Эндпоинты (сводка)

| Метод | URL | Описание |
|-------|-----|----------|
| GET | /api/v1/cms/seo-settings?site_id= | Настройки SEO по сайту (создаёт запись при отсутствии) |
| GET | /api/v1/cms/seo-settings/{id} | Просмотр записи |
| PUT | /api/v1/cms/seo-settings/{id} | Обновление |
| GET | /api/v1/cms/{entity}/{id}/seo-meta | Мета сущности (entity: pages, services, product-categories, products) |
| PUT | /api/v1/cms/{entity}/{id}/seo-meta | Upsert меты |
| GET | /api/v1/cms/redirects | Список редиректов (site_id, q, pagination) |
| POST | /api/v1/cms/redirects | Создание редиректа |
| GET/PUT/DELETE | /api/v1/cms/redirects/{id} | Просмотр, обновление, удаление |

---

## Как проверить

1. **Тесты:** `php artisan test` — все тесты (в т.ч. CmsSeoApiTest) должны проходить.
2. **Админка:** Войти в /admin → Страницы → открыть страницу на редактирование → вкладка SEO: заполнить поля, выбрать OG image из медиатеки, «Сохранить SEO». Проверить, что данные сохраняются (обновить страницу и снова открыть вкладку).
3. **SEO Настройки:** /admin → SEO Настройки → выбрать сайт → изменить default_title_suffix, default_description и т.д. → Сохранить.
4. **Редиректы:** /admin → Редиректы → выбрать сайт, поиск → Создать редирект (from_path например /old, to_url /new, code 301). Проверить уникальность: тот же from_path для того же сайта — ошибка; для другого сайта — ок.

---

## Файлы (новые/изменённые)

- app/Http/Controllers/Api/Cms/SeoSettingController.php
- app/Http/Controllers/Api/Cms/SeoMetaController.php
- app/Http/Controllers/Api/Cms/RedirectController.php
- app/Services/SeoResolver.php
- app/Models/ProductCategory.php (seoMeta, booted)
- routes/api.php (seo-settings, seo-meta, redirects)
- resources/js/pages/admin/cms/PageEdit.vue (вкладка SEO, CmsMediaPicker)
- resources/js/components/admin/cms/CmsMediaPicker.vue
- resources/js/pages/admin/cms/SeoSettings.vue
- resources/js/pages/admin/cms/Redirects.vue
- resources/js/admin.js (маршруты seo-settings, redirects)
- app/Services/AdminMenu.php (SEO Настройки, Редиректы)
- tests/Feature/CmsSeoApiTest.php
- docs/steps/STEP_05_04.md
- docs/ADMIN_MODULES.md (обновлён раздел SEO)
- docs/SEO_AND_SCHEMA.md (приоритет резолва, canonical, OG)
