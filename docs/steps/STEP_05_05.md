# Шаг 5.5 — Меню (Menus, MenuItems)

Реализованы /admin (Vue) и API (Laravel) для управления меню: Menus и MenuItems (вложенность, сортировка, link_type). Меню привязано к сайту (site_id NOT NULL); при использовании в публичном API — fallback на root site (is_primary=1). Без новых таблиц/полей; строго по миграциям и моделям.

---

## Что сделано

### Backend (Laravel), api/v1/cms, auth:sanctum

**MenuController**

- **GET** `/api/v1/cms/menus?site_id=&q=` — список меню с фильтром по site_id и поиском по slug/title.
- **POST** `/api/v1/cms/menus` — создание (site_id, slug, title). slug: только латиница, цифры, дефис, подчёркивание; UNIQUE(site_id, slug).
- **GET** `/api/v1/cms/menus/{id}` — просмотр меню.
- **PUT** `/api/v1/cms/menus/{id}` — обновление.
- **DELETE** `/api/v1/cms/menus/{id}` — удаление (каскад пунктов через FK).

**MenuItemController**

- **GET** `/api/v1/cms/menus/{menu}/items` — дерево пунктов (parent/children, order). Ответ: `{ data: { menu, items } }`, items — массив корневых узлов с вложенным `children`.
- **POST** `/api/v1/cms/menus/{menu}/items` — создание пункта (parent_id, title, link_type, link_value, open_new_tab, order).
- **PUT** `/api/v1/cms/menu-items/{id}` — обновление пункта.
- **DELETE** `/api/v1/cms/menu-items/{id}` — удаление с каскадным удалением потомков в приложении.
- **POST** `/api/v1/cms/menu-items/{id}/move` — перемещение: body `direction: up|down` или `order: int`.

**Валидация**

- title — required, max 255.
- parent_id — nullable, должен принадлежать тому же menu_id (Rule::exists + where menu_id).
- link_type — из списка: url, page, service, category, product.
- link_value — required. Для link_type=url — произвольная строка (URL или путь). Для page/service/category/product — slug сущности; проверка: запись существует в соответствующей таблице и принадлежит тому же site_id, что и меню.
- order — integer >= 0.
- open_new_tab — boolean.

**Удаление**

- Удаление меню — каскад пунктов через FK (menus cascadeOnDelete).
- Удаление пункта меню — в приложении рекурсивно удаляются все дочерние пункты, затем сам пункт (CASCADE в коде).

### Frontend (Vue /admin)

- **Menus.vue** — список меню с обязательным фильтром по сайту; поиск по slug/title; создание/редактирование/удаление меню в модалке; кнопка «Редактировать пункты» → переход в MenuEditor (маршрут cms/menus/:id/items).
- **MenuEditor.vue** — редактор пунктов выбранного меню: загрузка дерева (GET menus/{id}/items); отображение дерева через компонент MenuItemNode; добавление корневого пункта и вложенных (кнопка «+ Вложенный»); редактирование и удаление пункта; перемещение вверх/вниз в рамках одного уровня (кнопки ↑/↓). Форма пункта: title, link_type (url|page|service|category|product), link_value (для url — текст; для остальных — выбор из списка страниц/услуг/категорий/товаров того же site_id), open_new_tab, order.
- **MenuItemNode.vue** — рекурсивный компонент узла: отображение title и link_type/link_value; кнопки: + Вложенный, Изменить, ↑, ↓, Удалить. Передача siblingIndex/siblingCount для корректного включения/отключения кнопок вверх/вниз.
- В админ-меню добавлен пункт «Меню» (admin, manager).

### Тесты

**tests/Feature/CmsMenusApiTest.php** (13 тестов):

- menus: index требует auth; index с фильтром site_id; store создаёт меню; update и destroy.
- menu items: index возвращает дерево (menu + items с children); store корневого пункта; store дочернего пункта (parent_id).
- Валидация: parent_id из другого меню — 422; link_value для page — должен существовать и тот же site (успех для своего сайта, 422 для другого); link_value для category — существующий slug ок, несуществующий — 422.
- update и delete пункта; delete пункта каскадно удаляет дочерние; move (direction up/down) меняет order и дерево возвращается в правильном порядке.

---

## Эндпоинты (сводка)

| Метод | URL | Описание |
|-------|-----|----------|
| GET | /api/v1/cms/menus | Список (site_id, q, pagination) |
| POST | /api/v1/cms/menus | Создание меню |
| GET | /api/v1/cms/menus/{id} | Просмотр меню |
| PUT | /api/v1/cms/menus/{id} | Обновление меню |
| DELETE | /api/v1/cms/menus/{id} | Удаление меню |
| GET | /api/v1/cms/menus/{menu}/items | Дерево пунктов |
| POST | /api/v1/cms/menus/{menu}/items | Создание пункта |
| PUT | /api/v1/cms/menu-items/{id} | Обновление пункта |
| DELETE | /api/v1/cms/menu-items/{id} | Удаление пункта (и потомков) |
| POST | /api/v1/cms/menu-items/{id}/move | Перемещение (direction: up\|down или order) |

---

## Как проверить

1. **Тесты:** `php artisan test` — все тесты (в т.ч. CmsMenusApiTest) проходят.
2. **Админка:** Войти в /admin → Меню → выбрать сайт → создать меню (slug, например header, title по желанию). Нажать «Редактировать пункты» → добавить корневой пункт (например title «Главная», link_type url, link_value /). Добавить ещё пункт, затем вложенный к первому. Проверить кнопки ↑/↓ и изменение порядка. Редактирование и удаление пункта.
3. **Валидация:** Попытка создать пункт с link_type=page и link_value=slug с другого сайта — ошибка. parent_id от пункта другого меню — ошибка.

---

## Файлы (новые/изменённые)

- app/Http/Controllers/Api/Cms/MenuController.php
- app/Http/Controllers/Api/Cms/MenuItemController.php
- app/Models/Menu.php (HasFactory)
- database/factories/MenuFactory.php
- routes/api.php (menus, menu-items)
- resources/js/pages/admin/cms/Menus.vue
- resources/js/pages/admin/cms/MenuEditor.vue
- resources/js/components/admin/cms/MenuItemNode.vue
- resources/js/admin.js (маршруты cms/menus, cms/menus/:id/items)
- app/Services/AdminMenu.php (пункт «Меню»)
- tests/Feature/CmsMenusApiTest.php
- docs/steps/STEP_05_05.md
- docs/ADMIN_MODULES.md (раздел Меню)
- docs/API_CONTRACT.md (CMS endpoints для меню)
