# Шаг 5.3 — Content CMS: Pages, Services, ProductCategories, Products, ContentBlocks

Реализованы API и Vue-админка для контентных сущностей и блоков (page builder). Без новых таблиц/полей; строго по миграциям и DB_SCHEMA.md.

---

## Что сделано

### Backend (Laravel)

**Контроллеры** (`App\Http\Controllers\Api\Cms\`):

- **PageController** — index (site_id, q, status, page), store, show, update, destroy; publish, unpublish. Slug уникален в рамках site_id (Rule::unique).
- **ServiceController** — тот же набор CRUD + publish/unpublish.
- **ProductCategoryController** — index, store, show, update, destroy; image_media_id, image_active_media_id (exists:cms_media,id).
- **ProductController** — index (site_id, product_category_id, q, status), store, show, update, destroy; publish, unpublish; **syncGallery** (POST products/{id}/gallery, body: media_ids[]) — привязка медиа с role=gallery и order по индексу.
- **ContentBlockController** — indexForPage/Service/Product (GET pages|services|products/{id}/blocks), storeForPage/Service/Product (POST), update (PUT blocks/{id}), destroy (DELETE blocks/{id}), move (POST blocks/{id}/move, body: order или direction: up|down).

**Валидация блоков** (`App\Services\ContentBlockDataValidator`):

- Разрешённые типы: hero, simple_text, gallery, pr_table, form_low_price, zamer.
- По типу: hero (title, subtitle?, cta_text?, cta_url?), simple_text (html/text required_without), gallery (media_ids[], exists cms_media), pr_table (rows[]), form_low_price/zamer (enabled).

**Маршруты** (auth:sanctum, prefix api/v1/cms):

- apiResource: pages, services, product-categories, products.
- POST pages/{page}/publish, pages/{page}/unpublish; GET/POST pages/{page}/blocks.
- Аналогично для services и products (blocks, publish, unpublish).
- POST products/{product}/gallery.
- PUT blocks/{block}, DELETE blocks/{block}, POST blocks/{block}/move.

### Frontend (Vue)

**Страницы списков** (`resources/js/pages/admin/cms/`):

- **Pages.vue** — таблица, фильтры site_id, q, status; create/edit в модалке; slug автогенерация от title (редактируемый); кнопка «Блоки» → PageEdit.
- **Services.vue** — то же без перехода к отдельной edit (блоки можно добавить при необходимости по аналогии с PageEdit).
- **ProductCategories.vue** — список, фильтр по site_id; форма: site_id, title, slug, sort_order.
- **Products.vue** — список, фильтры site_id, status; форма: site_id, product_category_id, name, slug, short_description, price, price_old, status; категории подгружаются по site.

**Редактирование страницы и блоки**:

- **PageEdit.vue** — маршрут cms/pages/:id/edit; вкладки: Основное (title, slug, status), Блоки (ContentBlocksEditor), Медиа (подсказка), SEO (заглушка «будет в шаге 5.4»).
- **ContentBlocksEditor.vue** — пропсы entityType (pages|services|products), entityId; список блоков по order; добавление блока (выбор типа); редактирование data (JSON textarea); кнопки вверх/вниз (move), удаление.

**Меню админки** (`App\Services\AdminMenu`):

- Добавлены: Страницы, Услуги, Категории товаров, Товары (роли admin, manager).

### Тесты

**tests/Feature/CmsContentApiTest.php** (8 тестов):

- pages: index требует auth; store создаёт страницу; update и destroy.
- services: store + index.
- product_categories: store с валидным image_media_id; store с невалидным image_media_id — 422.
- products: store с category_id + syncGallery (проверка привязки медиа с role=gallery).
- blocks: создание блока для page (hero), move (direction down), delete.

### Файлы

**Новые/изменённые:**

- app/Services/ContentBlockDataValidator.php
- app/Http/Controllers/Api/Cms/PageController.php
- app/Http/Controllers/Api/Cms/ServiceController.php
- app/Http/Controllers/Api/Cms/ProductCategoryController.php
- app/Http/Controllers/Api/Cms/ProductController.php
- app/Http/Controllers/Api/Cms/ContentBlockController.php
- routes/api.php (cms: pages, services, product-categories, products, blocks)
- resources/js/pages/admin/cms/Pages.vue, Services.vue, ProductCategories.vue, Products.vue
- resources/js/pages/admin/cms/PageEdit.vue
- resources/js/components/admin/cms/ContentBlocksEditor.vue
- resources/js/admin.js (маршруты)
- app/Services/AdminMenu.php
- database/factories/ProductCategoryFactory.php, ProductFactory.php, ServiceFactory.php
- app/Models/Service.php, Product.php, ProductCategory.php (HasFactory + import)

---

## Эндпоинты (кратко)

| Метод | Путь | Описание |
|-------|------|----------|
| GET | /api/v1/cms/pages | Список (site_id, q, status, page) |
| POST | /api/v1/cms/pages | Создать |
| GET | /api/v1/cms/pages/{id} | Одна страница |
| PUT | /api/v1/cms/pages/{id} | Обновить |
| DELETE | /api/v1/cms/pages/{id} | Удалить |
| POST | /api/v1/cms/pages/{id}/publish | Опубликовать |
| POST | /api/v1/cms/pages/{id}/unpublish | Снять с публикации |
| GET | /api/v1/cms/pages/{id}/blocks | Список блоков |
| POST | /api/v1/cms/pages/{id}/blocks | Создать блок |
| Аналогично | services, products | CRUD + blocks, publish/unpublish |
| POST | /api/v1/cms/products/{id}/gallery | Синхронизация галереи (media_ids) |
| GET | /api/v1/cms/product-categories | Список категорий |
| CRUD | /api/v1/cms/product-categories | Создать/обновить/удалить |
| PUT | /api/v1/cms/blocks/{id} | Обновить блок |
| DELETE | /api/v1/cms/blocks/{id} | Удалить блок |
| POST | /api/v1/cms/blocks/{id}/move | Изменить порядок (order или direction) |

---

## Команды проверки

```bash
# Все тесты (в т.ч. ModelsRelations, Admin, CmsMultisite, CmsContent)
php artisan test

# Только контент и блоки
php artisan test tests/Feature/CmsContentApiTest.php

# Маршруты CMS
php artisan route:list --path=cms
```

**Ручная проверка:** зайти в /admin → Страницы / Услуги / Категории товаров / Товары: список, создание, редактирование, удаление. Для страницы — «Блоки» → редактирование страницы → вкладка «Блоки»: добавить блок (тип hero/simple_text/…), изменить data (JSON), вверх/вниз, удалить.

---

## Ограничения (соблюдены)

- Новые таблицы/поля не добавлялись.
- site_id везде NOT NULL в контенте.
- Медиа только cms_media/cms_media_files/cms_mediables.
- В админке показываются все записи; публикация (published + published_at <= now) — для фронта/API по требованию.
- Типы блоков и валидация data — по заданному списку и схемам.
